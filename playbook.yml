---
- name: apply common configuration to raspberry pi nodes
  hosts: localhost
  remote_user: root
  vars:
    sshd_skip_defaults: true
    sshd:
      Compression: true
      GSSAPIAuthentication: no
      PermitRootLogin: no
      # role: mivok0.users
    users:
      - username: federico
        name: Federico Castagnini
        groups: ['sudo']
        shell: /usr/bin/zsh
        uid: 2001
        ssh_key:
          - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDIWzy21UpPuFHiX0ENDB0K7SEFvOQW00REvlITr6MnZEI1izGpfhPh4Bfns/dx8IBf5pQZnJsqR1WdHCg9feqSb9gpyLl1CPnT1mXQJYefelSwgjQA5r8JEwPBLQldQeVYbWmeJbnzU7iJQsA8qQW9/D5ETTMl4fiJ4edrtFTJblHhq3kfJBACvfBEPE78hFSe/GgTe9mvQRMhhwXqhofUZ//oN6wLtXDH4IoLVOPpnMhPHVCL9kaThq8DbNLDkl5ZNIzT2pCKmtavVzJ3XeOnSJUuGKFvLqpqBanRHvt1Glfy3VEzOkCz9GUMF3u+/v+UUtOrESocfSOFy2QWYAbZ fede@arroz-con-leche"
    # raspberry_pi_boot_config_options:
      # Set the GPU memory split value.
      # - regexp: "^#?gpu_mem"
      #   line: "gpu_mem=16"
  roles:
    - { role: tersmitten.timezone }   # set timezone to UTC
    - { role: tersmitten.locales }    # set locale to en_US.UTF-8 UTF-8
    - { role: tersmitten.ntp }
    # - { role: tersmitten.swapfile, swapfile_size: 4GB, swapfile_swappiness: 10 }
    - { role: jnv.unattended-upgrades }
    - { role: mattwillsher.sshd }
    - role: tersmitten.fail2ban
      fail2ban_services:
      - name: ssh
        enabled: true
        port: ssh
        filter: sshd
        logpath: /var/log/auth.log
        maxretry: 5
        findtime: 1800
    - role: mivok0.users
    - role: mivok0.sudo
      sudo_users:
        - root
        - vagrant
        - "%sudo"
      users_create_per_user_group: false
    # - role: geerlingguy.raspberry-pi
  tasks:
    - name: Update package lists
      apt: update_cache=yes
    - name: Install common software
      apt: name={{ item }} state=present
      with_items:
        - htop
        - vim
        - sudo
        - zsh
        - screen
    - name: Remove unwanted packages
      apt: pkg={{ item }} state=absent purge=yes
      with_items:
        - dbus
        - tasksel
        - tasksel-data
        - debconf-i18n
        - nfacct
        - xdg-user-dirs
        - nano
        - vim-tiny
    - name: Install available package updates
      apt: upgrade=dist purge=yes

    ##############################
    # Install prezto
    - name: Install zprezto for federico
      git: repo=https://github.com/sorin-ionescu/prezto.git
           dest=/home/federico/.zprezto
           recursive=yes
    - name: Fix permissions after zprezto install
      command: chown -R federico:federico /home/federico/.zprezto
    - name: Linking zprezto rc files
      file: src=/tmp/{{ item.src }} dest={{ item.dest }} state=link owner=federico group=federico force=true
      with_items:
        - { src: '/home/federico/.zprezto/runcoms/zlogin',    dest: '/home/federico/.zlogin' }
        - { src: '/home/federico/.zprezto/runcoms/zpreztorc', dest: '/home/federico/.zpreztorc' }
        - { src: '/home/federico/.zprezto/runcoms/zprofile',  dest: '/home/federico/.zprofile' }
        - { src: '/home/federico/.zprezto/runcoms/zshenv',    dest: '/home/federico/.zshenv' }
        - { src: '/home/federico/.zprezto/runcoms/zshrc',     dest: '/home/federico/.zshrc' }
    ##############################

    - cron: name="duckdns update sample" minute="*/15" user="federico"
            job="echo url=\"https://www.duckdns.org/update?domains=exampledomain&token=exampletoken&ip=\" | curl -k -o /tmp/duck.log -K - >/dev/null 2>&1"
            cron_file=duckdns-update.sample
            state=present
            disabled=yes
    - sysctl:
        name: vm.swappiness
        value: 5
    - sysctl:
        name: net.ipv6.conf.all.disable_ipv6
        value: 1
    - sysctl:
        name: net.ipv6.conf.default.disable_ipv6
        value: 1
    - sysctl:
        name: net.ipv6.conf.lo.disable_ipv6
        value: 1
    - sysctl:
        name: net.ipv6.conf.eth0.disable_ipv6
        value: 1

    ##############################
    #
    # experimental features
    #
    # - name: Disable overscan
    #  replace: dest=/boot/firmware/config.txt regexp='^#disable_overscan=1' replace='disable_overscan=1'
    # - include: load_balancers.yml
